{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/inputs.schema.json",
  "title": "Spec-Driven App Inputs",
  "type": "object",
  "required": ["version", "inputs"],
  "additionalProperties": false,
  "properties": {
    "version": { "type": "integer", "minimum": 1 },
    "inputs": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "app",
        "domains",
        "env_urls",
        "deployment",
        "capabilities",
        "tenancy",
        "data",
        "constraints",
        "security",
        "object_storage",
        "ui",
        "governance"
      ],
      "properties": {
        "app": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "name", "purpose", "features"],
          "properties": {
            "type": { "type": "string", "enum": ["GENERIC", "POS"] },
            "name": { "type": "string", "minLength": 1 },
            "purpose": { "type": "string", "minLength": 1 },
            "features": {
              "type": "array",
              "minItems": 1,
              "items": { "type": "string", "minLength": 1 }
            }
          }
        },

        "domains": {
          "type": "object",
          "additionalProperties": false,
          "required": ["root_domain", "subdomains", "prefixes"],
          "properties": {
            "root_domain": { "type": "string", "minLength": 1 },
            "subdomains": {
              "type": "object",
              "additionalProperties": false,
              "required": ["staging", "production"],
              "properties": {
                "staging": { "type": "string", "minLength": 1 },
                "production": { "type": "string", "minLength": 1 }
              }
            },
            "prefixes": {
              "type": "object",
              "additionalProperties": false,
              "required": ["api", "realtime", "auth", "storage"],
              "properties": {
                "api": { "type": "string", "minLength": 1 },
                "realtime": { "type": "string", "minLength": 1 },
                "auth": { "type": "string", "minLength": 1 },
                "storage": { "type": "string", "minLength": 1 }
              }
            }
          }
        },

        "env_urls": {
          "type": "object",
          "additionalProperties": false,
          "required": ["development", "staging", "production"],
          "properties": {
            "development": { "$ref": "#/$defs/envUrlBlockDev" },
            "staging": { "$ref": "#/$defs/envUrlBlockProdLike" },
            "production": { "$ref": "#/$defs/envUrlBlockProdLike" }
          }
        },

        "deployment": {
          "type": "object",
          "additionalProperties": false,
          "required": ["strategy"],
          "properties": {
            "strategy": { "type": "string", "enum": ["compose", "compose+swarm", "k8s-later"] }
          }
        },

        "capabilities": {
          "type": "object",
          "additionalProperties": false,
          "required": ["realtime", "offline"],
          "properties": {
            "realtime": { "type": "string", "enum": ["none", "notifications", "live", "chat", "all"] },
            "offline": { "type": "string", "enum": ["none", "read-only", "offline-writes"] }
          }
        },

        "tenancy": {
          "type": "object",
          "additionalProperties": false,
          "required": ["mode"],
          "properties": {
            "mode": { "type": "string", "enum": ["single", "multi"] },
            "multi": { "$ref": "#/$defs/tenancyMulti" }
          },
          "allOf": [
            {
              "if": { "properties": { "mode": { "const": "single" } }, "required": ["mode"] },
              "then": { "not": { "required": ["multi"] } }
            },
            {
              "if": { "properties": { "mode": { "const": "multi" } }, "required": ["mode"] },
              "then": { "required": ["multi"] }
            }
          ]
        },

        "data": {
          "type": "object",
          "additionalProperties": false,
          "required": ["sensitivity"],
          "properties": {
            "sensitivity": { "type": "string", "enum": ["low", "medium", "high"] }
          }
        },

        "constraints": {
          "type": "object",
          "additionalProperties": false,
          "required": ["data_services"],
          "properties": {
            "data_services": {
              "type": "object",
              "additionalProperties": false,
              "required": ["mode"],
              "properties": {
                "mode": { "type": "string", "enum": ["local", "external"] },
                "external": { "$ref": "#/$defs/externalServices" }
              },
              "allOf": [
                {
                  "if": { "properties": { "mode": { "const": "local" } }, "required": ["mode"] },
                  "then": { "not": { "required": ["external"] } }
                },
                {
                  "if": { "properties": { "mode": { "const": "external" } }, "required": ["mode"] },
                  "then": { "required": ["external"] }
                }
              ]
            }
          }
        },

        "security": {
          "type": "object",
          "additionalProperties": false,
          "required": ["oidc"],
          "properties": {
            "oidc": {
              "type": "object",
              "additionalProperties": false,
              "required": ["provider", "realm", "dev_defaults"],
              "properties": {
                "provider": { "type": "string", "enum": ["keycloak", "generic"] },
                "realm": { "type": "string", "minLength": 1 },
                "dev_defaults": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["admin_user", "admin_password"],
                  "properties": {
                    "admin_user": { "type": "string", "minLength": 1 },
                    "admin_password": { "type": "string", "minLength": 1 }
                  }
                }
              }
            }
          }
        },

        "object_storage": {
          "type": "object",
          "additionalProperties": false,
          "required": ["provider", "bucket", "dev_defaults"],
          "properties": {
            "provider": { "type": "string", "enum": ["minio", "s3", "r2", "gcs"] },
            "bucket": { "type": "string", "minLength": 1 },
            "dev_defaults": {
              "type": "object",
              "additionalProperties": false,
              "required": ["root_user", "root_password"],
              "properties": {
                "root_user": { "type": "string", "minLength": 1 },
                "root_password": { "type": "string", "minLength": 1 }
              }
            }
          }
        },

        "ui": {
          "type": "object",
          "additionalProperties": false,
          "required": ["required_routes", "web_runtime"],
          "properties": {
            "required_routes": {
              "type": "object",
              "additionalProperties": false,
              "required": ["examples", "dashboard", "tasks", "authentication"],
              "properties": {
                "examples": { "type": "boolean" },
                "dashboard": { "type": "boolean" },
                "tasks": { "type": "boolean" },
                "authentication": { "type": "boolean" }
              }
            },
            "web_runtime": {
              "type": "object",
              "additionalProperties": false,
              "required": ["next_router", "hydration_policy", "shadcn_client_only"],
              "properties": {
                "next_router": { "type": "string", "enum": ["app", "pages"] },
                "hydration_policy": { "type": "string", "enum": ["strict", "relaxed"] },
                "shadcn_client_only": { "type": "boolean" },
                "client_boundaries": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["client_suffix", "server_suffix"],
                  "properties": {
                    "client_suffix": { "type": "string", "minLength": 1 },
                    "server_suffix": { "type": "string", "minLength": 1 }
                  }
                }
              },
              "allOf": [
                {
                  "if": { "properties": { "hydration_policy": { "const": "strict" } }, "required": ["hydration_policy"] },
                  "then": { "required": ["client_boundaries"] }
                }
              ]
            }
          }
        },

        "governance": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "enforce_oss_first",
            "enforce_compose_first",
            "enforce_k8s_ready",
            "enforce_hydration_safe_ui",
            "enforce_no_env_hardcoding"
          ],
          "properties": {
            "enforce_oss_first": { "type": "boolean" },
            "enforce_compose_first": { "type": "boolean" },
            "enforce_k8s_ready": { "type": "boolean" },
            "enforce_hydration_safe_ui": { "type": "boolean" },
            "enforce_no_env_hardcoding": { "type": "boolean" }
          }
        }
      }
    }
  },

  "$defs": {
    "httpUrlOrTemplate": {
      "type": "string",
      "anyOf": [
        { "pattern": "^https?://.+$" },
        { "pattern": "^https?://.*\\$\\{[^}]+\\}.*$" }
      ]
    },
    "wsUrlOrTemplate": {
      "type": "string",
      "anyOf": [
        { "pattern": "^(ws|wss)://.+$" },
        { "pattern": "^(ws|wss)://.*\\$\\{[^}]+\\}.*$" }
      ]
    },

    "envUrlBlockDev": {
      "type": "object",
      "additionalProperties": false,
      "required": ["web", "api", "realtime", "oidc_issuer", "object_storage_endpoint"],
      "properties": {
        "web": { "$ref": "#/$defs/httpUrlOrTemplate" },
        "api": { "$ref": "#/$defs/httpUrlOrTemplate" },
        "realtime": { "$ref": "#/$defs/wsUrlOrTemplate" },
        "oidc_issuer": { "$ref": "#/$defs/httpUrlOrTemplate" },
        "object_storage_endpoint": { "$ref": "#/$defs/httpUrlOrTemplate" }
      }
    },

    "envUrlBlockProdLike": {
      "type": "object",
      "additionalProperties": false,
      "required": ["web", "api", "realtime", "oidc_issuer", "object_storage_endpoint"],
      "properties": {
        "web": { "$ref": "#/$defs/httpUrlOrTemplate" },
        "api": { "$ref": "#/$defs/httpUrlOrTemplate" },
        "realtime": { "$ref": "#/$defs/wsUrlOrTemplate" },
        "oidc_issuer": { "$ref": "#/$defs/httpUrlOrTemplate" },
        "object_storage_endpoint": { "$ref": "#/$defs/httpUrlOrTemplate" }
      }
    },

    "tenancyMulti": {
      "type": "object",
      "additionalProperties": false,
      "required": ["strategy", "resolution"],
      "properties": {
        "strategy": { "type": "string", "enum": ["shared-db", "schema-per-tenant", "db-per-tenant"] },
        "resolution": {
          "type": "object",
          "additionalProperties": false,
          "required": ["method"],
          "properties": {
            "method": { "type": "string", "enum": ["subdomain", "header", "jwt-claim"] },
            "claim_key": { "type": "string", "minLength": 1 },
            "header_name": { "type": "string", "minLength": 1 },
            "subdomain_prefix": { "type": "string" }
          },
          "allOf": [
            {
              "if": { "properties": { "method": { "const": "jwt-claim" } }, "required": ["method"] },
              "then": {
                "required": ["claim_key"],
                "not": { "required": ["header_name"] }
              }
            },
            {
              "if": { "properties": { "method": { "const": "header" } }, "required": ["method"] },
              "then": {
                "required": ["header_name"],
                "not": { "required": ["claim_key"] }
              }
            },
            {
              "if": { "properties": { "method": { "const": "subdomain" } }, "required": ["method"] },
              "then": {
                "not": { "required": ["claim_key", "header_name"] }
              }
            }
          ]
        }
      }
    },

    "externalServices": {
      "type": "object",
      "additionalProperties": false,
      "required": ["postgres", "redis", "object_storage"],
      "properties": {
        "postgres": {
          "type": "object",
          "additionalProperties": false,
          "required": ["host", "port", "database", "ssl_mode"],
          "properties": {
            "host": { "type": "string", "minLength": 1 },
            "port": { "type": "integer", "minimum": 1, "maximum": 65535 },
            "database": { "type": "string", "minLength": 1 },
            "ssl_mode": { "type": "string", "enum": ["disable", "require", "verify-full"] }
          }
        },
        "redis": {
          "type": "object",
          "additionalProperties": false,
          "required": ["host", "port", "tls"],
          "properties": {
            "host": { "type": "string", "minLength": 1 },
            "port": { "type": "integer", "minimum": 1, "maximum": 65535 },
            "tls": { "type": "boolean" }
          }
        },
        "object_storage": {
          "type": "object",
          "additionalProperties": false,
          "required": ["provider", "endpoint", "bucket", "region"],
          "properties": {
            "provider": { "type": "string", "enum": ["s3", "r2", "gcs", "minio"] },
            "endpoint": { "type": "string", "minLength": 1 },
            "bucket": { "type": "string", "minLength": 1 },
            "region": { "type": "string", "minLength": 1 }
          }
        }
      }
    }
  }
}