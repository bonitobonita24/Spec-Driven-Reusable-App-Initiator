name: CI-CD

on:
  pull_request:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm via corepack
        run: |
          corepack enable
          corepack prepare pnpm@9.12.0 --activate

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Validate inputs
        run: pnpm validate:inputs

      - name: Render env
        run: pnpm render:inputs

      - name: Hydration lint
        run: pnpm lint:hydration

  cd_publish_images:
    # CD starts only on main branch pushes
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [ci]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image names
        id: meta
        run: |
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          REPO_LC="$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')"
          echo "owner_lc=$OWNER_LC" >> $GITHUB_OUTPUT
          echo "repo_lc=$REPO_LC" >> $GITHUB_OUTPUT
          echo "sha_short=$(echo "${{ github.sha }}" | cut -c1-12)" >> $GITHUB_OUTPUT

      - name: Build & push web image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/web/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.owner_lc }}/${{ steps.meta.outputs.repo_lc }}-web:sha-${{ steps.meta.outputs.sha_short }}
            ghcr.io/${{ steps.meta.outputs.owner_lc }}/${{ steps.meta.outputs.repo_lc }}-web:latest

      - name: Build & push api image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.owner_lc }}/${{ steps.meta.outputs.repo_lc }}-api:sha-${{ steps.meta.outputs.sha_short }}
            ghcr.io/${{ steps.meta.outputs.owner_lc }}/${{ steps.meta.outputs.repo_lc }}-api:latest

  # OPTIONAL: Compose-first staging deploy (enable by setting secrets)
  # Secrets needed:
  # - STAGING_HOST (e.g., 1.2.3.4)
  # - STAGING_USER (e.g., ubuntu)
  # - STAGING_SSH_KEY (private key)
  # - STAGING_PATH (e.g., /opt/myapp)
  #
  # cd_deploy_staging:
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   needs: [cd_publish_images]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Deploy via SSH (compose-first)
  #       uses: appleboy/ssh-action@v1.0.3
  #       with:
  #         host: ${{ secrets.STAGING_HOST }}
  #         username: ${{ secrets.STAGING_USER }}
  #         key: ${{ secrets.STAGING_SSH_KEY }}
  #         script: |
  #           cd "${{ secrets.STAGING_PATH }}"
  #           docker compose pull
  #           docker compose up -d